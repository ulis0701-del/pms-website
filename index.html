<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鎰呈行生管系統 v3.8 (Admin版-防崩潰修復)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (Excel處理) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Babel (用於瀏覽器端編譯 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Maps: 定義模組來源 -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
    }
    </script>
    
    <style>
        /* 自定義動畫與樣式 */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { font-family: "Noto Sans TC", sans-serif; }
        
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            max-height: 70vh;
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: #f1f5f9;
            z-index: 10;
            white-space: nowrap;
        }
        .action-col {
            position: sticky;
            right: 0;
            background-color: white;
            z-index: 5;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        .table-container thead th.action-col {
            background-color: #f1f5f9;
            z-index: 15;
        }
        tr:hover .action-col {
            background-color: #f8fafc;
        }
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <!-- 主程式邏輯 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAnalytics } from "firebase/analytics";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously, 
            signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            query, 
            doc, 
            writeBatch, 
            deleteDoc, 
            Timestamp 
        } from 'firebase/firestore';

        // --- 錯誤邊界元件 (防止白屏) ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center bg-red-50 p-8">
                            <div className="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full border border-red-200">
                                <h1 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                                    系統發生錯誤
                                </h1>
                                <p className="text-slate-600 mb-4">很抱歉，處理資料時發生了意外錯誤。這可能是因為 Excel 檔案格式異常或資料內容不符。</p>
                                <div className="bg-slate-100 p-4 rounded text-xs text-red-500 font-mono overflow-auto max-h-40 mb-6">
                                    {this.state.error && this.state.error.toString()}
                                </div>
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold transition-colors"
                                >
                                    重新整理頁面
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- 設定區 ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3ChFwdh00DHs5dKDmzGbICellr4p9KVQ",
            authDomain: "yeechain-pms.firebaseapp.com",
            projectId: "yeechain-pms",
            storageBucket: "yeechain-pms.firebasestorage.app",
            messagingSenderId: "435042400094",
            appId: "1:435042400094:web:251781923ae2c643d381cf",
            measurementId: "G-HMXZYNY1S1"
        };

        let app, auth, db, analytics;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase 初始化錯誤:", e);
        }

        // --- Icons ---
        const Icons = {
            Package: <><path d="m16.5 9.4-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.27 6.96 12 12.01l8.73-5.05"/><path d="M12 22.08V12"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            FileSpreadsheet: <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>,
            TrendingUp: <><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></>,
            Truck: <><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
            RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
            Database: <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>,
            Filter: <><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            FileOutput: <><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4 7V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6"/><path d="M4 12a2 2 0 0 1 2-2h2"/><path d="M4 17a2 2 0 0 0 2 2h2"/><line x1="4" x2="10" y1="12" y2="12"/></>,
            Factory: <><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><line x1="17" x2="17" y1="13" y2="22"/><line x1="9" x2="9" y1="13" y2="22"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            Key: <><path d="m21 2-2 2m-7.6 7.6a6 6 0 1 1-2.4-12 6 6 0 0 1 2.4 12z"/><path d="m10 15 5 5 3-3"/></>,
            Trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
            Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>,
            Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></>,
            Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>
        };

        const Icon = ({ name, className }) => {
            const content = Icons[name];
            if (!content) return null;
            return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{content}</svg>;
        };

        // --- Chart ---
        const SimpleBarChart = ({ data, title, colorClass = "bg-blue-500" }) => {
            if (!data || data.length === 0) return <div className="p-4 text-center text-slate-400">尚無資料</div>;
            const maxVal = Math.max(...data.map(d => d.value)) || 1;
            return (
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-full">
                    <h3 className="text-lg font-semibold text-slate-800 mb-4">{title}</h3>
                    <div className="space-y-4">
                        {data.map((item, idx) => (
                            <div key={idx} className="flex items-center gap-3 text-sm">
                                <div className="w-24 truncate font-medium text-slate-600 text-right" title={item.label}>{item.label}</div>
                                <div className="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${colorClass} progress-bar`} style={{ width: `${(item.value / maxVal) * 100}%` }}></div>
                                </div>
                                <div className="w-16 text-right text-slate-700 font-bold">{item.value.toLocaleString()}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Login ---
        const Login = ({ onAdminLogin, error }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-slate-100">
                        <div className="flex flex-col items-center mb-8">
                            <div className="mb-4">
                                <img src="logo.png" alt="Logo" className="h-16 w-auto mx-auto object-contain" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }} />
                                <div className="hidden bg-blue-600 p-3 rounded-full mx-auto justify-center items-center" style={{ width: 'fit-content' }}><Icon name="Package" className="w-8 h-8 text-white" /></div>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">鎰呈行生管系統</h1>
                            <p className="text-slate-500 text-sm mt-2">Yee Chain International Co., Ltd.</p>
                        </div>
                        {error && <div className="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg flex items-center gap-2"><Icon name="AlertCircle" className="w-4 h-4 flex-shrink-0" />{error}</div>}
                        <form onSubmit={(e) => { e.preventDefault(); onAdminLogin(username, password); }} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">帳號</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Icon name="User" className="h-5 w-5 text-slate-400" /></div>
                                    <input type="text" required className="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入帳號" value={username} onChange={(e) => setUsername(e.target.value)} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">密碼</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Icon name="Key" className="h-5 w-5 text-slate-400" /></div>
                                    <input type="password" required className="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入密碼" value={password} onChange={(e) => setPassword(e.target.value)} />
                                </div>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 mt-6"><span>登入系統</span></button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Dashboard ---
        const Dashboard = ({ user, onLogout }) => {
            const [fileData, setFileData] = useState([]);
            const [dbData, setDbData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [searchTerm, setSearchTerm] = useState('');
            const [errorMsg, setErrorMsg] = useState(null);
            const [successMsg, setSuccessMsg] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            const fileInputRef = useRef(null);

            useEffect(() => { fetchOrders(); }, [user]);

            const fetchOrders = async () => {
                if (!db) return;
                setLoading(true);
                try {
                    const q = query(collection(db, 'orders'));
                    const querySnapshot = await getDocs(q);
                    const data = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => {
                        const dateA = a['交貨日期'] || '9999-12-31';
                        const dateB = b['交貨日期'] || '9999-12-31';
                        return String(dateA).localeCompare(String(dateB));
                    });
                    setDbData(data);
                    setSelectedIds(new Set());
                } catch (error) {
                    console.error(error);
                    if (error.code === 'permission-denied') setErrorMsg("權限不足！請確認 Firestore Rules。");
                    else setErrorMsg("資料讀取失敗: " + error.message);
                } finally { setLoading(false); }
            };

            const processFile = (file) => {
                if (!file || !(file instanceof Blob)) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const wb = window.XLSX.read(data, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rawData = window.XLSX.utils.sheet_to_json(ws, { header: 1 });
                        
                        let headerRowIndex = -1;
                        for (let i = 0; i < Math.min(30, rawData.length); i++) {
                            const row = rawData[i];
                            if (Array.isArray(row)) {
                                const rowStr = row.map(cell => String(cell).trim());
                                if (rowStr.includes('訂單號碼') || (rowStr.includes('訂單日期') && rowStr.includes('客戶名稱'))) {
                                    headerRowIndex = i;
                                    break;
                                }
                            }
                        }

                        if (headerRowIndex === -1) { alert("無法自動偵測表頭！"); return; }

                        const jsonData = window.XLSX.utils.sheet_to_json(ws, { range: headerRowIndex });
                        
                        // 資料清理：移除重複欄位與空資料
                        const processedJson = jsonData.map(row => {
                            const newRow = { ...row };
                            Object.keys(newRow).forEach(key => {
                                if (key.endsWith('_1') && newRow[key.replace('_1', '')] !== undefined) {
                                    delete newRow[key];
                                }
                            });
                            return newRow;
                        });

                        const cleanData = processedJson.filter(row => {
                            if (!row) return false;
                            const keys = Object.keys(row);
                            const orderKey = keys.find(key => key && key.trim() === '訂單號碼');
                            return orderKey && row[orderKey] && row[orderKey] !== '訂單號碼';
                        });
                        
                        if (cleanData.length === 0) { alert("匯入失敗：無有效資料"); return; }

                        setFileData(cleanData);
                        setActiveTab('import');
                        setSuccessMsg(`成功讀取 ${cleanData.length} 筆資料！`);
                        setTimeout(() => setSuccessMsg(null), 5000);
                    } catch (error) {
                        alert("解析錯誤：" + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); if(e.dataTransfer) e.dataTransfer.dropEffect='copy'; setIsDragging(true); };
            const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); };

            const saveToFirestore = async () => {
                if (fileData.length === 0 || !db) return;
                setUploading(true);
                try {
                    const batchSize = 450;
                    const chunks = [];
                    for (let i = 0; i < fileData.length; i += batchSize) chunks.push(fileData.slice(i, i + batchSize));
                    for (const chunk of chunks) {
                        const batch = writeBatch(db);
                        chunk.forEach((row) => {
                            const cleanRow = {};
                            // 安全地處理 Key
                            Object.keys(row).forEach(key => {
                                if (key) cleanRow[key.trim()] = row[key];
                            });
                            const docRef = doc(collection(db, 'orders'));
                            batch.set(docRef, { ...cleanRow, uploadedAt: Timestamp.now(), uploadedBy: user.displayName || 'Admin' });
                        });
                        await batch.commit();
                    }
                    alert("匯入成功！");
                    setFileData([]); fetchOrders(); setActiveTab('list');
                } catch (e) { alert("匯入失敗: " + e.message); } finally { setUploading(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm("確定刪除？")) return;
                setLoading(true);
                try {
                    await deleteDoc(doc(db, 'orders', id));
                    setSuccessMsg("刪除成功"); setTimeout(()=>setSuccessMsg(null),3000);
                    setDbData(prev => prev.filter(i=>i.id!==id));
                    const ns = new Set(selectedIds); ns.delete(id); setSelectedIds(ns);
                } catch(e) { alert(e.message); } finally { setLoading(false); }
            };

            const handleDeleteSelected = async () => {
                if (!confirm(`刪除 ${selectedIds.size} 筆？`)) return;
                setLoading(true);
                try {
                    const batch = writeBatch(db);
                    selectedIds.forEach(id => batch.delete(doc(db, 'orders', id)));
                    await batch.commit();
                    setDbData(prev => prev.filter(i => !selectedIds.has(i.id)));
                    setSelectedIds(new Set());
                    setSuccessMsg("批量刪除成功"); setTimeout(()=>setSuccessMsg(null),3000);
                } catch(e) { alert(e.message); } finally { setLoading(false); }
            };

            // 輔助函式：安全取得值 (修復：確保 obj 存在)
            const getValue = (obj, keyName) => {
                if (!obj) return '';
                const key = Object.keys(obj).find(k => k.trim() === keyName);
                return key ? obj[key] : '';
            };
            const getQty = (obj) => {
                if (!obj) return 0;
                const key = Object.keys(obj).find(k => k.trim().includes('未交量'));
                let val = key ? obj[key] : 0;
                if (typeof val === 'string') val = val.replace(/,/g, '');
                return parseFloat(val) || 0;
            };

            const filteredData = useMemo(() => {
                return dbData.filter(item => {
                    const str = searchTerm.toLowerCase();
                    return (
                        (getValue(item,'訂單號碼') || '').toString().toLowerCase().includes(str) ||
                        (getValue(item,'客戶名稱') || '').toString().toLowerCase().includes(str) ||
                        (getValue(item,'公司品名') || '').toString().toLowerCase().includes(str)
                    );
                });
            }, [dbData, searchTerm]);

            const stats = useMemo(() => {
                const today = new Date().toISOString().split('T')[0];
                let totalUnfulfilled=0, overdueCount=0;
                const customersMap={}, monthlyMap={};

                dbData.forEach(d => {
                    const qty = getQty(d);
                    totalUnfulfilled += qty;
                    // 修正：使用交貨日期
                    const date = getValue(d, '交貨日期');
                    if (date && date < today && qty > 0) overdueCount++;
                    const client = getValue(d, '客戶名稱') || 'Unknown';
                    customersMap[client] = (customersMap[client]||0) + qty;
                    if (date && date.length>=7) {
                        const m = date.substring(0,7);
                        monthlyMap[m] = (monthlyMap[m]||0) + qty;
                    }
                });

                const urgentList = dbData.filter(d=>getQty(d)>0)
                    .sort((a,b) => (getValue(a,'交貨日期')||'9').localeCompare(getValue(b,'交貨日期')||'9'))
                    .slice(0,5);

                return {
                    totalOrders: dbData.length,
                    totalUnfulfilled,
                    overdueCount,
                    uniqueCustomers: Object.keys(customersMap).length,
                    topCustomers: Object.entries(customersMap).map(([label,v])=>({label,value:v})).sort((a,b)=>b.value-a.value).slice(0,5),
                    timeline: Object.entries(monthlyMap).map(([label,v])=>({label,value:v})).sort((a,b)=>a.label.localeCompare(b.label)).slice(0,6),
                    urgentList
                };
            }, [dbData]);

            // 防崩潰：importHeaders
            const importHeaders = useMemo(() => {
                if (!fileData || fileData.length === 0 || !fileData[0]) return [];
                return Object.keys(fileData[0]);
            }, [fileData]);

            // 防崩潰：allTableHeaders
            const allTableHeaders = useMemo(() => {
                if (!dbData || dbData.length === 0) return [];
                const keys = new Set();
                dbData.slice(0,50).forEach(row => {
                    if(row) Object.keys(row).forEach(k => {
                        if (k!=='id' && k!=='uploadedAt' && k!=='uploadedBy') keys.add(k);
                    });
                });
                const priorityKeys = ['交貨日期', '訂單號碼', '客戶名稱', '公司品名', '顏色', '未交量'];
                return Array.from(keys).sort((a,b)=>{
                    const idxA = priorityKeys.findIndex(pk=>a.includes(pk));
                    const idxB = priorityKeys.findIndex(pk=>b.includes(pk));
                    if(idxA!==-1 && idxB!==-1) return idxA-idxB;
                    if(idxA!==-1) return -1;
                    if(idxB!==-1) return 1;
                    return a.localeCompare(b,'zh-TW');
                });
            }, [dbData]);

            const handleExport = (dataToExport, name) => {
                if(!dataToExport.length) {alert("無資料"); return;}
                const exportData = dataToExport.map(row => ({
                    '交貨日期': getValue(row, '交貨日期'),
                    '訂單號碼': getValue(row, '訂單號碼'),
                    '客戶單號': getValue(row, '客戶單號'),
                    '客戶名稱': getValue(row, '客戶名稱'),
                    '品牌': getValue(row, '品牌'),
                    '公司品名': getValue(row, '公司品名'),
                    '成份': getValue(row, '成份'),
                    '加工方式': getValue(row, '加工方式'),
                    '中文顏色': getValue(row, '中文顏色'),
                    '英文顏色': getValue(row, '英文顏色'),
                    '未交量': getQty(row),
                    '鞋名': getValue(row, '鞋名'),
                    '季節': getValue(row, '季節(出貨)'),
                    '備註': getValue(row, '備註(出貨)')
                }));
                const ws = window.XLSX.utils.json_to_sheet(exportData);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                window.XLSX.writeFile(wb, `${name}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="flex flex-col h-full w-full">
                    {errorMsg && <div className="bg-red-50 p-4 border-l-4 border-red-500 text-red-700 mb-4">{errorMsg}</div>}
                    {successMsg && <div className="bg-green-50 p-4 border-l-4 border-green-500 text-green-700 mb-4 animate-fade-in">{successMsg}</div>}

                    <div className="flex space-x-1 bg-slate-200 p-1 rounded-lg w-fit mb-6">
                        <button onClick={()=>setActiveTab('dashboard')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab==='dashboard'?'bg-white text-blue-600 shadow-sm':'text-slate-600'}`}>儀表板</button>
                        <button onClick={()=>setActiveTab('list')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab==='list'?'bg-white text-blue-600 shadow-sm':'text-slate-600'}`}>未交訂單列表</button>
                        <button onClick={()=>setActiveTab('import')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab==='import'?'bg-white text-blue-600 shadow-sm':'text-slate-600'}`}>匯入新資料</button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 min-h-[500px] overflow-hidden">
                        {activeTab === 'dashboard' && (
                            <div className="p-6 bg-slate-50 h-full overflow-y-auto">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between"><div className="text-slate-500 text-sm">未交訂單<p className="text-2xl font-bold text-slate-800">{stats.totalOrders}</p></div><div className="bg-blue-50 p-3 rounded-lg"><Icon name="FileSpreadsheet" className="w-6 h-6 text-blue-600"/></div></div>
                                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between"><div className="text-slate-500 text-sm">未交總量<p className="text-2xl font-bold text-emerald-600">{stats.totalUnfulfilled.toLocaleString()}</p></div><div className="bg-emerald-50 p-3 rounded-lg"><Icon name="TrendingUp" className="w-6 h-6 text-emerald-600"/></div></div>
                                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between"><div className="text-slate-500 text-sm">逾期急件<p className="text-2xl font-bold text-red-600">{stats.overdueCount}</p></div><div className="bg-red-50 p-3 rounded-lg"><Icon name="Bell" className="w-6 h-6 text-red-600"/></div></div>
                                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between"><div className="text-slate-500 text-sm">客戶家數<p className="text-2xl font-bold text-purple-600">{stats.uniqueCustomers}</p></div><div className="bg-purple-50 p-3 rounded-lg"><Icon name="Truck" className="w-6 h-6 text-purple-600"/></div></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <SimpleBarChart data={stats.topCustomers} title="前 5 大客戶 (未交量)" />
                                    <SimpleBarChart data={stats.timeline} title="交期波段預估" colorClass="bg-emerald-500" />
                                </div>
                                <div className="bg-white p-6 rounded-xl border shadow-sm">
                                    <div className="flex justify-between mb-4"><h3 className="font-bold flex gap-2"><Icon name="Calendar" className="w-5 h-5"/> 即將到期 / 逾期急件 (前5筆)</h3></div>
                                    <table className="w-full text-sm text-left"><thead className="bg-slate-50"><tr><th className="px-4 py-2">交貨日期</th><th className="px-4 py-2">訂單</th><th className="px-4 py-2">客戶</th><th className="px-4 py-2 text-right">量</th></tr></thead>
                                        <tbody>
                                            {stats.urgentList.map((r,i)=>(<tr key={i} className="border-b"><td className="px-4 py-2 text-red-600 font-bold">{getValue(r,'交貨日期')}</td><td className="px-4 py-2">{getValue(r,'訂單號碼')}</td><td className="px-4 py-2">{getValue(r,'客戶名稱')}</td><td className="px-4 py-2 text-right">{getQty(r)}</td></tr>))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'import' && (
                            <div className="p-6">
                                <div onClick={()=>fileInputRef.current.click()} onDragOver={handleDragOver} onDrop={handleDrop} className={`border-2 border-dashed rounded-xl p-8 flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 cursor-pointer mb-6 ${isDragging?'border-blue-500':''}`}>
                                    <input type="file" ref={fileInputRef} onChange={(e)=>processFile(e.target.files[0])} className="hidden" accept=".xlsx,.xls"/>
                                    <Icon name="Upload" className="w-12 h-12 text-blue-500 mb-4"/><p className="font-medium text-slate-700">點擊或拖曳 Excel 檔案</p>
                                </div>
                                {fileData.length>0 && (
                                    <div className="animate-fade-in">
                                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex gap-2"><Icon name="CheckCircle" className="text-green-500 w-5 h-5"/> 預覽 {fileData.length} 筆</h3>
                                        <div className="flex gap-2"><button onClick={()=>setFileData([])} className="px-3 py-1 text-slate-600 hover:bg-slate-100 rounded">取消</button><button onClick={saveToFirestore} disabled={uploading} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">確認匯入</button></div></div>
                                        <div className="table-container border rounded max-h-[500px]">
                                            <table className="w-full text-sm text-left"><thead className="bg-slate-100"><tr>{importHeaders.map((h,i)=><th key={i} className="px-4 py-2 border-b">{h}</th>)}</tr></thead><tbody>{fileData.slice(0,50).map((r,i)=><tr key={i} className="bg-white border-b hover:bg-slate-50">{importHeaders.map((h,j)=><td key={j} className="px-4 py-2">{r[h]}</td>)}</tr>)}</tbody></table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'list' && (
                            <div className="flex flex-col h-full">
                                <div className="p-4 border-b flex justify-between items-center bg-white">
                                    <div className="relative max-w-md flex-1"><Icon name="Search" className="absolute left-3 top-2.5 w-4 h-4 text-slate-400"/><input type="text" placeholder="搜尋..." value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} className="pl-10 pr-4 py-2 border rounded-lg w-full"/></div>
                                    <div className="flex gap-2">
                                        <button onClick={fetchOrders} className="p-2 hover:bg-slate-100 rounded"><Icon name="RefreshCw" className="w-5 h-5"/></button>
                                        {selectedIds.size>0 ? (
                                            <>
                                                <button onClick={handleDeleteSelected} className="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 flex gap-1"><Icon name="Trash" className="w-4 h-4"/> 刪除 ({selectedIds.size})</button>
                                                <button onClick={()=>handleExport(filteredData.filter(i=>selectedIds.has(i.id)), '選取匯出')} className="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 flex gap-1"><Icon name="Download" className="w-4 h-4"/> 匯出</button>
                                            </>
                                        ):(
                                            <>
                                                <button onClick={handleDeleteAll} className="text-red-600 border border-red-200 px-3 py-2 rounded hover:bg-red-50 flex gap-1"><Icon name="Trash2" className="w-4 h-4"/> 清空</button>
                                                <button onClick={()=>handleExport(filteredData, '整理後報表')} className="bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700 flex gap-1"><Icon name="FileOutput" className="w-4 h-4"/> 匯出全部</button>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto table-container">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="px-4 py-3 w-12 text-center"><input type="checkbox" onChange={(e)=>{if(e.target.checked) setSelectedIds(new Set(filteredData.map(i=>i.id))); else setSelectedIds(new Set());}} checked={filteredData.length>0 && selectedIds.size===filteredData.length}/></th>
                                                {allTableHeaders.map((h,i)=><th key={i} className="px-4 py-3 border-b">{h}</th>)}
                                                <th className="px-4 py-3 border-b action-col text-center">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredData.map(row => (
                                                <tr key={row.id} className={`border-b hover:bg-slate-50 ${selectedIds.has(row.id)?'bg-blue-50':'bg-white'}`}>
                                                    <td className="px-4 py-3 text-center"><input type="checkbox" checked={selectedIds.has(row.id)} onChange={()=>{const ns=new Set(selectedIds); if(ns.has(row.id)) ns.delete(row.id); else ns.add(row.id); setSelectedIds(ns);}}/></td>
                                                    {allTableHeaders.map((h,i)=><td key={i} className="px-4 py-3 whitespace-nowrap">{row[h]}</td>)}
                                                    <td className="px-4 py-3 action-col text-center"><button onClick={()=>handleDelete(row.id)} className="text-slate-400 hover:text-red-600"><Icon name="Trash" className="w-4 h-4"/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-2 border-t text-right text-xs text-slate-500">顯示 {filteredData.length} 筆</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [loginError, setLoginError] = useState(null);

            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                return onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
            }, []);

            const handleLogin = async (u, p) => {
                if(!auth){setLoginError("Firebase Error"); return;}
                if(u==='admin' && p==='sweet405') {
                    try { await signInAnonymously(auth); } catch(e){setLoginError(e.message);}
                } else { setLoginError("帳號或密碼錯誤"); }
            };

            if (loading) return <div className="min-h-screen flex justify-center items-center"><Icon name="RefreshCw" className="animate-spin w-8 h-8 text-blue-600"/></div>;

            return (
                <ErrorBoundary>
                    <div className="min-h-screen bg-slate-50 flex flex-col">
                        {user && (
                            <header className="bg-white shadow-sm border-b sticky top-0 z-20 px-6 py-3 flex justify-between items-center">
                                <div className="flex items-center gap-2 font-bold text-xl text-slate-800"><Icon name="Package" className="text-blue-600 w-6 h-6"/> 鎰呈行生管系統 v3.8</div>
                                <button onClick={()=>signOut(auth)} className="text-slate-500 hover:text-red-600"><Icon name="LogOut" className="w-5 h-5"/></button>
                            </header>
                        )}
                        <main className="flex-1 max-w-7xl mx-auto w-full p-4">
                            {user ? <Dashboard user={user}/> : <Login onAdminLogin={handleLogin} error={loginError}/>}
                        </main>
                    </div>
                </ErrorBoundary>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
